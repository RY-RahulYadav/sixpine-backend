name: Deploy Backend

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Upload Backend Files to VPS
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/tmp/backend/"

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "â¬‡ï¸ Removing old backend..."
            rm -rf /var/www/sixpine/backend

            echo "ğŸ“ Moving new backend..."
            mv /tmp/backend /var/www/sixpine/backend

            cd /var/www/sixpine/backend

            echo "ğŸ“ Writing environment file..."
            cat <<EOF > .env
            # Django Settings
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            DEBUG=${{ secrets.DEBUG }}

            # Database Configuration (PostgreSQL)
            DB_ENGINE=${{ secrets.DB_ENGINE }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_SSLMODE=${{ secrets.DB_SSLMODE }}

            # Razorpay Configuration
            RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
            RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}

            # Email Configuration
            EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
            
            BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
            BREVO_SENDER_EMAIL=${{ secrets.BREVO_SENDER_EMAIL }}
            BREVO_SENDER_NAME=${{ secrets.BREVO_SENDER_NAME }}

            # Google OAuth2 Configuration
            # GOOGLE_OAUTH2_CLIENT_ID=${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
            # GOOGLE_OAUTH2_CLIENT_SECRET=${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
            # GOOGLE_OAUTH2_REFRESH_TOKEN=${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}

            CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
            CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
            CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
            
            CASHFREE_APP_ID=${{ secrets.CASHFREE_APP_ID }}
            CASHFREE_SECRET_KEY=${{ secrets.CASHFREE_SECRET_KEY }}    
            CASHFREE_ENVIRONMENT=${{ secrets.CASHFREE_ENVIRONMENT }}
            ADMIN_NOTIFICATION_EMAIL=${{ secrets.ADMIN_NOTIFICATION_EMAIL }}

            # Frontend URL
            # FRONTEND_URL=${{ secrets.FRONTEND_URL }}

            # CORS Settings
            # CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}

            # Twilio Configuration (optional)
            # TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
            # TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
            # TWILIO_WHATSAPP_FROM=${{ secrets.TWILIO_WHATSAPP_FROM }}

            # Security Settings
            SECURE_SSL_REDIRECT=${{ secrets.SECURE_SSL_REDIRECT }}
            EOF

            echo "ğŸ Setting up Python virtual environment..."
            python3 -m venv venv
            source venv/bin/activate

            echo "â¬†ï¸ Upgrading pip..."
            pip install --upgrade pip

            echo "ğŸ“¦ Installing dependencies..."
            pip install -r requirements.txt

            echo "ğŸ”§ Running migrations..."
            export DJANGO_SETTINGS_MODULE=ecommerce_backend.settings
            python manage.py migrate --noinput

            echo "ğŸ“ Collecting static files..."
            python manage.py collectstatic --noinput
            # python seed_trending_page_sections.py
            # python  seed_homepage_all_sections.py 
            # python seed_best_deals_page_sections.py
            # python upload_new_sixpine_watermark.py
            # python  seed_navbar_categories.py
            # python manage.py fix_style_spec_order 2>&1

            echo "ğŸ”„ Restarting Gunicorn..."
            systemctl restart gunicorn-sixpine

            echo "âœ… Backend deployment complete!"
